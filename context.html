
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="ja">
  <head>
    <meta charset="utf-8" />
    <title>Go Concurrency Patterns: Context &#8212; Go database/sql tutorial  ドキュメント</title>
    <link rel="stylesheet" href="_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/translations.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="検索" href="search.html" />
    <link rel="next" title="TODO(内部用)" href="todo.html" />
    <link rel="prev" title="Go Slices: usage and internals" href="slices_usage_and_internals.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <a href="https://github.com/d-tsuji/go-blog-ja"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://camo.githubusercontent.com/a6677b08c955af8400f44c6298f40e7d19cc5b2d/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f677261795f3664366436642e706e67" alt="Fork me on GitHub" data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png"></a><div class="section" id="go-concurrency-patterns-context">
<h1>Go Concurrency Patterns: Context<a class="headerlink" href="#go-concurrency-patterns-context" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="id1">
<h2>概要<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Goのサーバーでは、要求されたリクエストはそれぞれのゴルーチンで処理されます。リクエストハンドラーは多くの場合、データベースやgRPCサーバといったバックエンドにアクセスするために、新しいゴルーチンを作成します。通常、リクエストを処理するゴルーチンのセットは、エンドユーザーを識別するID、認証トークン、リクエストの期限といったリクエスト固有の値にアクセスする必要があります。リクエストがキャンセルまたはタイムアウトになった場合、そのリクエストに紐付いて動いているゴルーチンはすぐに終了し、システムが使用中のリソースを回収できるようになります。</p>
<p>Googleでは、APIの境界を越えて、リクエストの処理に関係するすべてのゴルーチンに、リクエストスコープの値、キャンセルシグナル、および期限を簡単に渡すことができる <code class="docutils literal notranslate"><span class="pre">context</span></code> パッケージを開発しました。パッケージは、 <code class="docutils literal notranslate"><span class="pre">context</span></code> として公開されています。この記事では、パッケージの使用方法について説明し、そのままで動作する実例を提供します。</p>
</div>
<div class="section" id="context">
<h2>Context<a class="headerlink" href="#context" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p><code class="docutils literal notranslate"><span class="pre">context</span></code> パッケージの中核は、 <code class="docutils literal notranslate"><span class="pre">Context</span></code> 型です。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// A Context carries a deadline, cancelation signal, and request-scoped values</span>
<span class="c1">// across API boundaries. Its methods are safe for simultaneous use by multiple</span>
<span class="c1">// goroutines.</span>
<span class="kd">type</span> <span class="nx">Context</span> <span class="kd">interface</span> <span class="p">{</span>
    <span class="c1">// Done returns a channel that is closed when this Context is canceled</span>
    <span class="c1">// or times out.</span>
    <span class="nx">Done</span><span class="p">()</span> <span class="o">&lt;-</span><span class="kd">chan</span> <span class="kd">struct</span><span class="p">{}</span>

    <span class="c1">// Err indicates why this context was canceled, after the Done channel</span>
    <span class="c1">// is closed.</span>
    <span class="nx">Err</span><span class="p">()</span> <span class="kt">error</span>

    <span class="c1">// Deadline returns the time when this Context will be canceled, if any.</span>
    <span class="nx">Deadline</span><span class="p">()</span> <span class="p">(</span><span class="nx">deadline</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Time</span><span class="p">,</span> <span class="nx">ok</span> <span class="kt">bool</span><span class="p">)</span>

    <span class="c1">// Value returns the value associated with key or nil if none.</span>
    <span class="nx">Value</span><span class="p">(</span><span class="nx">key</span> <span class="kd">interface</span><span class="p">{})</span> <span class="kd">interface</span><span class="p">{}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>(上記の説明は、GoDocの抜粋です)</p>
<p><code class="docutils literal notranslate"><span class="pre">Done</span></code> メソッドは <code class="docutils literal notranslate"><span class="pre">Context</span></code> に代わって、実行されている関数にキャンセルのシグナルとして機能するチャネルを返します。チャネルが閉じられると、関数は処理を中止して終了します。<code class="docutils literal notranslate"><span class="pre">Err</span></code> メソッドは、<code class="docutils literal notranslate"><span class="pre">Context</span></code> がキャンセルされた理由を示すエラーを返します。「Pipelines and Cancelation」の記事では、<code class="docutils literal notranslate"><span class="pre">Done</span></code> チャネルのイディオムについて詳しく説明しています。</p>
<p><code class="docutils literal notranslate"><span class="pre">Done</span></code> チャネルが受信専用であることと同じ理由で、<code class="docutils literal notranslate"><span class="pre">Context</span></code> は <code class="docutils literal notranslate"><span class="pre">Cancel</span></code> メソッドが <cite>ありません</cite> 。通常の場合、キャンセルシグナルを受信する関数はシグナルを送信する関数ではありません。特に親の操作が子の操作としてゴルーチンを開始する場合、子の操作は親をキャンセルできないようにすべきです。代わりに <code class="docutils literal notranslate"><span class="pre">WithCancel</span></code> 関数(後ほど説明)はキャンセルするための <code class="docutils literal notranslate"><span class="pre">Context</span></code> の値を提供します。</p>
<p><code class="docutils literal notranslate"><span class="pre">Context</span></code> は、複数のゴルーチンで同時に使用しても安全です。コードは1つの <code class="docutils literal notranslate"><span class="pre">Context</span></code> を任意の数のゴルーチンに渡し、その <code class="docutils literal notranslate"><span class="pre">Context</span></code> をキャンセルしてすべてのゴルーチンを通知できます。</p>
<p><code class="docutils literal notranslate"><span class="pre">Deadline</span></code> メソッドを使用すると、関数で処理を開始するかどうかを決定できます。期限までほとんど時間がない場合、処理する価値がないかもしれません。コードはを用いて、I/O操作のタイムアウトを設定することもできます。</p>
<p><code class="docutils literal notranslate"><span class="pre">Value</span></code> を使用すると <code class="docutils literal notranslate"><span class="pre">Context</span></code> でリクエストスコープのデータを送ることができます。そのデータは、複数のゴルーチンによる同時使用に対して安全でなければなりません。</p>
<div class="section" id="id2">
<h3>コンテキストの派生<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><code class="docutils literal notranslate"><span class="pre">context</span></code> パッケージは元のコンテキストから新しい <code class="docutils literal notranslate"><span class="pre">Context</span></code> の値を生成する関数を提供しています。コンテキストは木を形成します。根の <code class="docutils literal notranslate"><span class="pre">Context</span></code> がキャンセルされると、そこから派生したすべての <code class="docutils literal notranslate"><span class="pre">Context</span></code> もキャンセルされます。</p>
<p><code class="docutils literal notranslate"><span class="pre">Background</span></code> は <code class="docutils literal notranslate"><span class="pre">Context</span></code> の木の根になります。キャンセルされることはありません。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Background returns an empty Context. It is never canceled, has no deadline,</span>
<span class="c1">// and has no values. Background is typically used in main, init, and tests,</span>
<span class="c1">// and as the top-level Context for incoming requests.</span>
<span class="kd">func</span> <span class="nx">Background</span><span class="p">()</span> <span class="nx">Context</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">WithCancel</span></code> と <code class="docutils literal notranslate"><span class="pre">WithTimeout</span></code> は派生した <code class="docutils literal notranslate"><span class="pre">Context</span></code> の値を返し、それらは親の <code class="docutils literal notranslate"><span class="pre">Context</span></code> よりも早くキャンセルできます。通常 <code class="docutils literal notranslate"><span class="pre">Context</span></code> はリクエストに関連する <code class="docutils literal notranslate"><span class="pre">Context</span></code> はリクエストハンドラが返却されるとキャンセルされます。</p>
<div class="admonition-todo admonition" id="id3">
<p class="admonition-title">課題</p>
<p>ちょっと違和感がある。</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Context</span></code> associated with an incoming request is typically canceled when the request handler returns.</p>
</div>
<p><code class="docutils literal notranslate"><span class="pre">WithCancel</span></code> は複数のレプリカを使用しているときに、冗長なリクエストをキャンセルする場合にも役に立ちます。<code class="docutils literal notranslate"><span class="pre">WithTimeout</span></code> はバックエンドサーバへのリクエストに期限を設定するのに役立ちます。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// WithCancel returns a copy of parent whose Done channel is closed as soon as</span>
<span class="c1">// parent.Done is closed or cancel is called.</span>
<span class="kd">func</span> <span class="nx">WithCancel</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">ctx</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">cancel</span> <span class="nx">CancelFunc</span><span class="p">)</span>

<span class="c1">// A CancelFunc cancels a Context.</span>
<span class="kd">type</span> <span class="nx">CancelFunc</span> <span class="kd">func</span><span class="p">()</span>

<span class="c1">// WithTimeout returns a copy of parent whose Done channel is closed as soon as</span>
<span class="c1">// parent.Done is closed, cancel is called, or timeout elapses. The new</span>
<span class="c1">// Context&#39;s Deadline is the sooner of now+timeout and the parent&#39;s deadline, if</span>
<span class="c1">// any. If the timer is still running, the cancel function releases its</span>
<span class="c1">// resources.</span>
<span class="kd">func</span> <span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">timeout</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span><span class="p">)</span> <span class="p">(</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">CancelFunc</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">WithValue</span></code> はリクエストスコープの値を <code class="docutils literal notranslate"><span class="pre">Context</span></code> に関連付ける方法を提供します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// WithValue returns a copy of parent whose Value method returns val for key.</span>
<span class="kd">func</span> <span class="nx">WithValue</span><span class="p">(</span><span class="nx">parent</span> <span class="nx">Context</span><span class="p">,</span> <span class="nx">key</span> <span class="kd">interface</span><span class="p">{},</span> <span class="nx">val</span> <span class="kd">interface</span><span class="p">{})</span> <span class="nx">Context</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Context</span></code> の使用方法を知る最善の方法は、実際の例を使用することです。</p>
</div>
</div>
<div class="section" id="googleweb">
<h2>例: GoogleのWeb検索<a class="headerlink" href="#googleweb" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>「golang」を検索するクエリを <a class="reference external" href="[https://developers.google.com/web-search/docs/">Google Web Search API</a> に投げ、結果をレンダリングする <code class="docutils literal notranslate"><span class="pre">/search?q=golang&amp;timeout=1s</span></code> のようなURLを扱うHTTPサーバの例を見てみましょう。<code class="docutils literal notranslate"><span class="pre">timeout</span></code> パラメータはその期間が経過した後にリクエストをキャンセルするようにサーバーに指示します。</p>
<p>コードは以下の3つのパッケージに分かれます。</p>
<ul class="simple">
<li><p><a class="reference external" href="https://blog.golang.org/context/server/server.go">server</a> はメイン関数と <code class="docutils literal notranslate"><span class="pre">/search</span></code> を扱うハンドラを提供します。</p></li>
<li><p><a class="reference external" href="https://blog.golang.org/context/userip/userip.go">userip</a> はリクエストからユーザーIPアドレスを抽出し、それを <code class="docutils literal notranslate"><span class="pre">Context</span></code> に関連付ける機能を提供します。</p></li>
<li><p><a class="reference external" href="https://blog.golang.org/context/google/google.go">google</a> はクエリをGoogleに送信するための <code class="docutils literal notranslate"><span class="pre">検索</span></code> 機能を提供します。</p></li>
</ul>
<div class="section" id="id4">
<h3>サーバープログラム<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://blog.golang.org/context/server/server.go">サーバー</a> プログラムは <code class="docutils literal notranslate"><span class="pre">golang</span></code> の最初のいくつかのGoogle検索結果を提供することにより、<code class="docutils literal notranslate"><span class="pre">/search?q=golang</span></code> などのリクエストを処理します。<code class="docutils literal notranslate"><span class="pre">handlesearch</span></code> を <code class="docutils literal notranslate"><span class="pre">/search</span></code> エンドポイントに登録します。ハンドラは <code class="docutils literal notranslate"><span class="pre">ctx</span></code> という起点になる <code class="docutils literal notranslate"><span class="pre">Context</span></code> を作成し、ハンドラが戻ったときにキャンセルされるように調整します。リクエストに <code class="docutils literal notranslate"><span class="pre">timeout</span></code> のクエリパラメーターが含まれている場合、タイムアウトが経過するとコンテキストは自動的にキャンセルされます。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">handleSearch</span><span class="p">(</span><span class="nx">w</span> <span class="nx">http</span><span class="p">.</span><span class="nx">ResponseWriter</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ctx is the Context for this handler. Calling cancel closes the</span>
    <span class="c1">// ctx.Done channel, which is the cancellation signal for requests</span>
    <span class="c1">// started by this handler.</span>
    <span class="kd">var</span> <span class="p">(</span>
        <span class="nx">ctx</span>    <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span>
        <span class="nx">cancel</span> <span class="nx">context</span><span class="p">.</span><span class="nx">CancelFunc</span>
    <span class="p">)</span>
    <span class="nx">timeout</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">ParseDuration</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;timeout&quot;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="c1">// The request has a timeout, so create a context that is</span>
        <span class="c1">// canceled automatically when the timeout expires.</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">WithTimeout</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">(),</span> <span class="nx">timeout</span><span class="p">)</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nx">ctx</span><span class="p">,</span> <span class="nx">cancel</span> <span class="p">=</span> <span class="nx">context</span><span class="p">.</span><span class="nx">WithCancel</span><span class="p">(</span><span class="nx">context</span><span class="p">.</span><span class="nx">Background</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">cancel</span><span class="p">()</span> <span class="c1">// Cancel ctx as soon as handleSearch returns.</span>
</pre></div>
</div>
<p>ハンドラーは、リクエストからクエリを抽出し <code class="docutils literal notranslate"><span class="pre">userip</span></code> パッケージを呼び出してクライアントのIPアドレスを抽出します。クライアントのIPアドレスはバックエンドへのリクエストに必要であるため <code class="docutils literal notranslate"><span class="pre">handleSearch</span></code> はIPアドレスを <code class="docutils literal notranslate"><span class="pre">ctx</span></code> に付与します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Check the search query.</span>
<span class="nx">query</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">FormValue</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">query</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="s">&quot;no query&quot;</span><span class="p">,</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>

<span class="c1">// Store the user IP in ctx for use by code in other packages.</span>
<span class="nx">userIP</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">userip</span><span class="p">.</span><span class="nx">FromRequest</span><span class="p">(</span><span class="nx">req</span><span class="p">)</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">http</span><span class="p">.</span><span class="nx">Error</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="nx">err</span><span class="p">.</span><span class="nx">Error</span><span class="p">(),</span> <span class="nx">http</span><span class="p">.</span><span class="nx">StatusBadRequest</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="nx">ctx</span> <span class="p">=</span> <span class="nx">userip</span><span class="p">.</span><span class="nx">NewContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">userIP</span><span class="p">)</span>
</pre></div>
</div>
<p>ハンドラは <code class="docutils literal notranslate"><span class="pre">ctx</span></code> と <code class="docutils literal notranslate"><span class="pre">query</span></code> を使用して <code class="docutils literal notranslate"><span class="pre">google.Search</span></code> を呼び出します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// Run the Google search and print the results.</span>
<span class="nx">start</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">()</span>
<span class="nx">results</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">google</span><span class="p">.</span><span class="nx">Search</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span>
<span class="nx">elapsed</span> <span class="o">:=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Since</span><span class="p">(</span><span class="nx">start</span><span class="p">)</span>
</pre></div>
</div>
<p>検索が完了すると、ハンドラは検索結果をレンダリングします。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">resultsTemplate</span><span class="p">.</span><span class="nx">Execute</span><span class="p">(</span><span class="nx">w</span><span class="p">,</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Results</span>          <span class="nx">google</span><span class="p">.</span><span class="nx">Results</span>
    <span class="nx">Timeout</span><span class="p">,</span> <span class="nx">Elapsed</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Duration</span>
<span class="p">}{</span>
    <span class="nx">Results</span><span class="p">:</span> <span class="nx">results</span><span class="p">,</span>
    <span class="nx">Timeout</span><span class="p">:</span> <span class="nx">timeout</span><span class="p">,</span>
    <span class="nx">Elapsed</span><span class="p">:</span> <span class="nx">elapsed</span><span class="p">,</span>
<span class="p">});</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Print</span><span class="p">(</span><span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id6">
<h3>useripパッケージ<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://blog.golang.org/context/userip/userip.go">userip</a> パッケージは、リクエストからユーザーIPアドレスを抽出し、それを <code class="docutils literal notranslate"><span class="pre">Context</span></code> に関連付ける機能を提供します。<code class="docutils literal notranslate"><span class="pre">Context</span></code> は、キーと値の両方が型 <code class="docutils literal notranslate"><span class="pre">interface{}</span></code> であるキーと値のマッピングを提供します。キーの型は等価性をサポートする必要があり、値は複数のゴルーチンが同時に使用しても安全でなければなりません。<code class="docutils literal notranslate"><span class="pre">userip</span></code> などのパッケージは、このマッピングの詳細を隠し、特定の <code class="docutils literal notranslate"><span class="pre">Context</span></code> 値への厳密に型指定されたアクセスを提供します。</p>
<p>キーの衝突を避けるために、<code class="docutils literal notranslate"><span class="pre">userip</span></code> はエクスポートされていない <code class="docutils literal notranslate"><span class="pre">key</span></code> 型を定義し、この型の値をコンテキストのキーとして使用します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="c1">// The key type is unexported to prevent collisions with context keys defined in</span>
<span class="c1">// other packages.</span>
<span class="kd">type</span> <span class="nx">key</span> <span class="kt">int</span>

<span class="c1">// userIPkey is the context key for the user IP address.  Its value of zero is</span>
<span class="c1">// arbitrary.  If this package defined other context keys, they would have</span>
<span class="c1">// different integer values.</span>
<span class="kd">const</span> <span class="nx">userIPKey</span> <span class="nx">key</span> <span class="p">=</span> <span class="mi">0</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">FromRequest</span></code> は <code class="docutils literal notranslate"><span class="pre">http.Request</span></code> から <code class="docutils literal notranslate"><span class="pre">userIP</span></code> の値を抽出します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">FromRequest</span><span class="p">(</span><span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">ip</span><span class="p">,</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">net</span><span class="p">.</span><span class="nx">SplitHostPort</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">fmt</span><span class="p">.</span><span class="nx">Errorf</span><span class="p">(</span><span class="s">&quot;userip: %q is not IP:port&quot;</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">RemoteAddr</span><span class="p">)</span>
    <span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">NewContext</span></code> は、指定された <code class="docutils literal notranslate"><span class="pre">userIP</span></code> 値を保持する新しい <code class="docutils literal notranslate"><span class="pre">Context</span></code> を返します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">NewContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">userIP</span> <span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">)</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">context</span><span class="p">.</span><span class="nx">WithValue</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">userIPKey</span><span class="p">,</span> <span class="nx">userIP</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">FromContext</span></code> は <code class="docutils literal notranslate"><span class="pre">Context</span></code> から <code class="docutils literal notranslate"><span class="pre">userIP</span></code> を抽出します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">FromContext</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">)</span> <span class="p">(</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">,</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// ctx.Value returns nil if ctx has no value for the key;</span>
    <span class="c1">// the net.IP type assertion returns ok=false for nil.</span>
    <span class="nx">userIP</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Value</span><span class="p">(</span><span class="nx">userIPKey</span><span class="p">).(</span><span class="nx">net</span><span class="p">.</span><span class="nx">IP</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">userIP</span><span class="p">,</span> <span class="nx">ok</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id8">
<h3>googleパッケージ<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p><a class="reference external" href="https://blog.golang.org/context/google/google.go">google.Search</a> 関数は <a class="reference external" href="https://developers.google.com/web-search/docs/">Google Web Search API</a> へのHTTPリクエストを作成し、JSONエンコードされた結果を解析します。<code class="docutils literal notranslate"><span class="pre">Context</span></code> パラメータ <code class="docutils literal notranslate"><span class="pre">ctx</span></code> を受け取り、リクエストの実行中に <code class="docutils literal notranslate"><span class="pre">ctx.Done</span></code> が閉じられるとすぐに戻ります。</p>
<p>Google Web Search APIリクエストには、クエリパラメータとして検索クエリとユーザーIPが含まれます。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">Search</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">query</span> <span class="kt">string</span><span class="p">)</span> <span class="p">(</span><span class="nx">Results</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Prepare the Google Search API request.</span>
    <span class="nx">req</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">http</span><span class="p">.</span><span class="nx">NewRequest</span><span class="p">(</span><span class="s">&quot;GET&quot;</span><span class="p">,</span> <span class="s">&quot;https://ajax.googleapis.com/ajax/services/search/web?v=1.0&quot;</span><span class="p">,</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="nx">q</span> <span class="o">:=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">Query</span><span class="p">()</span>
    <span class="nx">q</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;q&quot;</span><span class="p">,</span> <span class="nx">query</span><span class="p">)</span>

    <span class="c1">// If ctx is carrying the user IP address, forward it to the server.</span>
    <span class="c1">// Google APIs use the user IP to distinguish server-initiated requests</span>
    <span class="c1">// from end-user requests.</span>
    <span class="k">if</span> <span class="nx">userIP</span><span class="p">,</span> <span class="nx">ok</span> <span class="o">:=</span> <span class="nx">userip</span><span class="p">.</span><span class="nx">FromContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">);</span> <span class="nx">ok</span> <span class="p">{</span>
        <span class="nx">q</span><span class="p">.</span><span class="nx">Set</span><span class="p">(</span><span class="s">&quot;userip&quot;</span><span class="p">,</span> <span class="nx">userIP</span><span class="p">.</span><span class="nx">String</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="nx">req</span><span class="p">.</span><span class="nx">URL</span><span class="p">.</span><span class="nx">RawQuery</span> <span class="p">=</span> <span class="nx">q</span><span class="p">.</span><span class="nx">Encode</span><span class="p">()</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Search</span></code> では、ヘルパー関数 <code class="docutils literal notranslate"><span class="pre">httpDo</span></code> を使用してHTTPリクエストを発行し、リクエストまたはレスポンスの処理中に <code class="docutils literal notranslate"><span class="pre">ctx.Done</span></code> が閉じられた場合、キャンセルします。<code class="docutils literal notranslate"><span class="pre">Search</span></code> は <code class="docutils literal notranslate"><span class="pre">httpDo</span></code> にクロージャーを渡し、HTTPレスポンスを処理します。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">var</span> <span class="nx">results</span> <span class="nx">Results</span>
<span class="nx">err</span> <span class="p">=</span> <span class="nx">httpDo</span><span class="p">(</span><span class="nx">ctx</span><span class="p">,</span> <span class="nx">req</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">resp</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="nx">err</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">defer</span> <span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>

    <span class="c1">// Parse the JSON search result.</span>
    <span class="c1">// https://developers.google.com/web-search/docs/#fonje</span>
    <span class="kd">var</span> <span class="nx">data</span> <span class="kd">struct</span> <span class="p">{</span>
        <span class="nx">ResponseData</span> <span class="kd">struct</span> <span class="p">{</span>
            <span class="nx">Results</span> <span class="p">[]</span><span class="kd">struct</span> <span class="p">{</span>
                <span class="nx">TitleNoFormatting</span> <span class="kt">string</span>
                <span class="nx">URL</span>               <span class="kt">string</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">json</span><span class="p">.</span><span class="nx">NewDecoder</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">Body</span><span class="p">).</span><span class="nx">Decode</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">data</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">res</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">data</span><span class="p">.</span><span class="nx">ResponseData</span><span class="p">.</span><span class="nx">Results</span> <span class="p">{</span>
        <span class="nx">results</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">results</span><span class="p">,</span> <span class="nx">Result</span><span class="p">{</span><span class="nx">Title</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">TitleNoFormatting</span><span class="p">,</span> <span class="nx">URL</span><span class="p">:</span> <span class="nx">res</span><span class="p">.</span><span class="nx">URL</span><span class="p">})</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">nil</span>
<span class="p">})</span>
<span class="c1">// httpDo waits for the closure we provided to return, so it&#39;s safe to</span>
<span class="c1">// read results here.</span>
<span class="k">return</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">err</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">httpDo``関数はHTTPリクエストを実行し、そのレスポンスを新しいゴルーチンで処理します。ゴルーチンが終了する前に</span> <span class="pre">``ctx.Done</span></code> が閉じられると、リクエストをキャンセルします。</p>
<div class="highlight-go notranslate"><div class="highlight"><pre><span></span><span class="kd">func</span> <span class="nx">httpDo</span><span class="p">(</span><span class="nx">ctx</span> <span class="nx">context</span><span class="p">.</span><span class="nx">Context</span><span class="p">,</span> <span class="nx">req</span> <span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="nx">f</span> <span class="kd">func</span><span class="p">(</span><span class="o">*</span><span class="nx">http</span><span class="p">.</span><span class="nx">Response</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
    <span class="c1">// Run the HTTP request in a goroutine and pass the response to f.</span>
    <span class="nx">c</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">req</span> <span class="p">=</span> <span class="nx">req</span><span class="p">.</span><span class="nx">WithContext</span><span class="p">(</span><span class="nx">ctx</span><span class="p">)</span>
    <span class="k">go</span> <span class="kd">func</span><span class="p">()</span> <span class="p">{</span> <span class="nx">c</span> <span class="o">&lt;-</span> <span class="nx">f</span><span class="p">(</span><span class="nx">http</span><span class="p">.</span><span class="nx">DefaultClient</span><span class="p">.</span><span class="nx">Do</span><span class="p">(</span><span class="nx">req</span><span class="p">))</span> <span class="p">}()</span>
    <span class="k">select</span> <span class="p">{</span>
    <span class="k">case</span> <span class="o">&lt;-</span><span class="nx">ctx</span><span class="p">.</span><span class="nx">Done</span><span class="p">():</span>
        <span class="o">&lt;-</span><span class="nx">c</span> <span class="c1">// Wait for f to return.</span>
        <span class="k">return</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">Err</span><span class="p">()</span>
    <span class="k">case</span> <span class="nx">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="nx">c</span><span class="p">:</span>
        <span class="k">return</span> <span class="nx">err</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id10">
<h2>コンテキストに合わせたコードの適合<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>多くのサーバーフレームワークは、リクエストスコープの値を運ぶためのパッケージと型を提供します。<code class="docutils literal notranslate"><span class="pre">Context</span></code> インターフェースの新しい実装を定義して、既存のフレームワークを使用するコードと <code class="docutils literal notranslate"><span class="pre">Context</span></code> パラメーターを必要とするコードを橋渡しします。</p>
<p>例えば、Gorillaの <a class="reference external" href="http://www.gorillatoolkit.org/pkg/context">github.com/gorilla/context</a> パッケージを使用すると、ハンドラーはHTTPリクエストからキーと値のペアへのマッピングを提供することで、要求されたリクエストにデータを関連付けることができます。<a class="reference external" href="https://blog.golang.org/context/gorilla/gorilla.go">gorilla.go</a> では、ValueメソッドがGorillaパッケージの特定のHTTPリクエストに関連付けられた値を返す <code class="docutils literal notranslate"><span class="pre">Context</span></code> 実装を提供します。</p>
<p>他のパッケージは <code class="docutils literal notranslate"><span class="pre">Context</span></code> と同様のキャンセルサポートを提供しています。 例えば <a class="reference external" href="https://godoc.org/gopkg.in/tomb.v2">Tomb</a> は <code class="docutils literal notranslate"><span class="pre">Dying</span></code> チャネルを閉じることによりキャンセルを通知するKillメソッドを提供します。<code class="docutils literal notranslate"><span class="pre">Tomb</span></code> は <code class="docutils literal notranslate"><span class="pre">sync.WaitGroup</span></code> と同様に、これらのゴルーチンが終了するのを待つメソッドも提供します。<a class="reference external" href="https://blog.golang.org/context/tomb/tomb.go">tomb.go</a> では、親 <code class="docutils literal notranslate"><span class="pre">Context</span></code> がキャンセルされるか、提供された <code class="docutils literal notranslate"><span class="pre">Tomb</span></code> が強制終了されるとキャンセルされる <code class="docutils literal notranslate"><span class="pre">Context</span></code> 実装を提供します。</p>
</div>
<div class="section" id="id11">
<h2>結論<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Googleでは、リクエストとレスポンスの間で呼び出されるすべての関数に、最初の引数として <code class="docutils literal notranslate"><span class="pre">Context</span></code> パラメータを渡すことを要求しています。これによりGoのコードは多くの異なるチームで相互運用できます。タイムアウトとキャンセルを簡単に制御し、またセキュリティ資格情報などの重要な値がGoのプログラム上で適切に扱われるようにします。</p>
<p><code class="docutils literal notranslate"><span class="pre">Context</span></code> に用いて実装したいサーバーフレームワークは、フレームワークと <code class="docutils literal notranslate"><span class="pre">Context</span></code> パラメーターを期待するパッケージとの間を橋渡しする <code class="docutils literal notranslate"><span class="pre">Context</span></code> の実装を提供する必要があります。クライアントライブラリは、呼び出し元のコードから <code class="docutils literal notranslate"><span class="pre">Context</span></code> を受け入れます。リクエストスコープのデータとキャンセル用の共通インターフェースを構築することにより、<code class="docutils literal notranslate"><span class="pre">Context</span></code> はパッケージ開発者がスケーラブルなサービスを作成するためのコードを簡単に共有できるようにします。</p>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div id="toc" class="sidebarRow">
    <h5><a href="index.html">The Go Blog</a></h5>
    <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="slices_usage_and_internals.html">Go Slices: usage and internals</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Go Concurrency Patterns: Context</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="todo.html">TODO(内部用)</a></li>
</ul>

    
</div>

<style type="text/css">
    .toctree-l1 {
        font-size: 12px;
        margin-bottom: 0;
        font-stretch: normal;
        font-style: normal;
        line-height: 1.33;
        padding-bottom: 5px;
        margin: 2px;
    }
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;VividCortex (translated by @d-tsuji).
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/context.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>